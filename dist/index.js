import b from'eventemitter3';var d={reconnect:true,reconnectInitialDelayMs:500,reconnectMaxDelayMs:12e3,reconnectJitter:.2,requestTimeoutMs:8e3,heartbeatIntervalMs:15e3};function m(){return typeof performance<"u"&&performance.now?performance.now():Date.now()}var c=class{url;opts;ws=null;ee=new b;status="idle";reconnectAttempt=0;connectPromise=null;heartbeatTimer=null;awaitingResponse=false;manualClose=false;queue=[];constructor(e,s={}){this.url=e,this.opts={...d,...s};}getStatus(){return this.status}on(e,s){return this.ee.on(e,s),()=>this.ee.off(e,s)}setStatus(e){this.status=e;}log(e,s,t){this.opts.onLog?.(e,s,t);}async connect(){if(typeof WebSocket>"u")throw new Error("WebSocket API not available. valis-client is browser-only.");if(!(this.ws&&this.ws.readyState===WebSocket.OPEN))return this.connectPromise?this.connectPromise:(this.manualClose=false,this.setStatus("connecting"),this.connectPromise=new Promise((e,s)=>{let t=new WebSocket(this.url);this.ws=t;let i=()=>{t.removeEventListener("open",r),t.removeEventListener("message",u),t.removeEventListener("close",l),t.removeEventListener("error",h);},r=()=>{this.setStatus("open"),this.reconnectAttempt=0,this.ee.emit("open",new Event("open")),this.log("info","WebSocket open"),this.flushQueue(),this.startHeartbeat(),this.connectPromise=null,e();},u=o=>{let n=o.data;if(typeof n=="string")try{n=JSON.parse(n);}catch{}this.awaitingResponse=false;let a=this.queue.shift();a?(globalThis.clearTimeout(a.timeoutId),a.resolve(n)):this.ee.emit("message",n),this.flushQueue();},l=o=>{for(this.setStatus("closed"),this.log("warn","WebSocket closed",{code:o.code,reason:o.reason}),this.stopHeartbeat(),this.ee.emit("close",o);this.queue.length;){let n=this.queue.shift();globalThis.clearTimeout(n.timeoutId),n.reject(new Error("Connection closed"));}i(),this.ws=null,this.connectPromise=null,!this.manualClose&&this.opts.reconnect&&this.scheduleReconnect();},h=o=>{let n=o instanceof Error?o:new Error("WebSocket error");this.ee.emit("error",n),this.log("error","WebSocket error",n);};t.addEventListener("open",r),t.addEventListener("message",u),t.addEventListener("close",l),t.addEventListener("error",h);let p=globalThis.setTimeout(()=>{if(this.status!=="open"){try{t.close(4e3,"connect-timeout");}catch{}this.connectPromise=null,s(new Error(`Connect timeout after ${this.opts.requestTimeoutMs} ms`));}},this.opts.requestTimeoutMs);t.addEventListener("open",()=>{globalThis.clearTimeout(p);},{once:true});}),this.connectPromise)}async disconnect(e,s){this.manualClose=true,this.setStatus("closing"),this.stopHeartbeat();try{this.ws?.close(e,s);}catch{}this.ws=null,this.setStatus("closed"),this.connectPromise=null;}async sendCommand(e){(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&await this.connect();let s=typeof e=="string"?e:JSON.stringify(e);return new Promise((t,i)=>{let r=globalThis.setTimeout(()=>{this.queue[0]?.payload===s&&(this.queue.shift(),this.awaitingResponse=false),i(new Error(`Request timed out after ${this.opts.requestTimeoutMs} ms`)),this.maybeReconnectOnTimeout();},this.opts.requestTimeoutMs);this.queue.push({payload:s,resolve:t,reject:i,timeoutId:r}),this.flushQueue();})}async getNetwork(){return this.sendCommand("network")}async getTokens(){return this.sendCommand("tokens")}flushQueue(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN||this.awaitingResponse)return;let e=this.queue[0];e&&(this.awaitingResponse=true,this.ws.send(e.payload));}startHeartbeat(){let e=this.opts.heartbeatIntervalMs;!e||e<=0||(this.stopHeartbeat(),this.heartbeatTimer=globalThis.setInterval(async()=>{if(!(this.awaitingResponse||this.queue.length>0))try{let s=m();await this.sendCommand("network");let t=Math.max(0,Math.round(m()-s));this.ee.emit("heartbeat",{ok:!0,rttMs:t});}catch{this.ee.emit("heartbeat",{ok:false}),this.maybeReconnectOnTimeout();}},e));}stopHeartbeat(){this.heartbeatTimer!=null&&(globalThis.clearInterval(this.heartbeatTimer),this.heartbeatTimer=null);}scheduleReconnect(){this.setStatus("reconnecting");let e=Math.min(this.opts.reconnectMaxDelayMs??12e3,(this.opts.reconnectInitialDelayMs??500)*Math.pow(2,this.reconnectAttempt++)),s=e*(this.opts.reconnectJitter??.2)*Math.random(),t=Math.floor(e+s);this.ee.emit("reconnecting",{attempt:this.reconnectAttempt,delayMs:t}),globalThis.setTimeout(()=>this.connect().catch(()=>{}),t);}maybeReconnectOnTimeout(){if(this.ws&&this.ws.readyState===WebSocket.OPEN&&this.opts.reconnect){this.log("warn","Timeout/heartbeat failure; reconnecting");try{this.ws.close(4001,"timeout");}catch{}}}};export{c as ValisClient};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map